<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>init.py</title>
  <link rel="stylesheet" href="../../pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>init.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">petname</span>
<span class="kn">import</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">collections</span> <span class="c1"># for OrderedDict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;workspace&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Check if cwd contains .builder, or if any of it's parents contain one (if so, we're in a builder repository)
If not, create it and populate it with a 'config' file that will contain initial config
If so, print error 'Current/parent directory already contains a .builder folder'</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">parent_path</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">parent_contains</span><span class="p">(</span><span class="s1">&#39;.builder&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">parent_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">print</span> <span class="s1">&#39;Error: I can</span><span class="se">\&#39;</span><span class="s1">t do that.&#39;</span>
		<span class="k">print</span> <span class="s1">&#39;Reason: There is already a .builder directory at </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">parent_path</span>
		<span class="k">print</span> <span class="s1">&#39;Hint: Use `cd` to change to a different directory.&#39;</span> 

	<span class="k">else</span><span class="p">:</span>

		<span class="n">builder_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwdu</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Initialize the builder root file system</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">builder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">builder_root</span><span class="p">,</span> <span class="s1">&#39;.builder&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">builder_path</span><span class="p">):</span>
			<span class="k">print</span> <span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">builder_path</span> 
			<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">builder_path</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Initialize builder config file
builder_config = collections.OrderedDict()
builder_config['name'] = petname.Generate(2) if name == None else name
builder_config['uuid'] = str(uuid.uuid4()) # TODO: Read UUID from device via Builder API
builder_config['role'] = str(role)
builder_config['project'] = 'none'</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">builder_config</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">petname</span><span class="o">.</span><span class="n">Generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">name</span><span class="p">,</span>
			<span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span> <span class="c1"># TODO: read UUID from hardware!</span>
			<span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">role</span><span class="p">),</span>
			<span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span>
		<span class="p">}</span>
		<span class="n">builder_config_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">builder_config</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

		<span class="n">builder_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">builder_root</span><span class="p">,</span> <span class="s1">&#39;.builder&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">builder_config_path</span><span class="p">):</span>
			<span class="k">print</span> <span class="s1">&#39;touch </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">builder_config_path</span> 
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">builder_config_path</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
				<span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">builder_config_json</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>create interface configuration</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">system_controller_source</span> <span class="o">=</span> <span class="s1">&#39;import builder</span><span class="se">\n</span><span class="s1">import builder.api</span><span class="se">\n</span><span class="s1">print builder.api.version()&#39;</span>
		
		<span class="n">system_controller_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">builder_root</span><span class="p">,</span> <span class="s1">&#39;system.py&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">system_controller_path</span><span class="p">):</span>
			<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;touch </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">system_controller_path</span><span class="p">)</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">system_controller_path</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
				<span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">system_controller_source</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>builder init zesty-koala --virtual</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;builder&#39;</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>This is done only builder devices. Not dev machines!
Add insecure pre-shared SSH public key (to boostrap communications)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">insecure_ssh_public_key</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="s1">&#39;public_key&#39;</span><span class="p">)</span>
			<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;echo &quot;</span><span class="si">%s</span><span class="s1">&quot; | cat &gt;&gt; ~/.ssh/authorized_keys&#39;</span> <span class="o">%</span> <span class="n">insecure_ssh_public_key</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;workspace&#39;</span><span class="p">:</span>
			<span class="n">insecure_ssh_private_key</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_data_filename</span><span class="p">(</span><span class="s1">&#39;private_key&#39;</span><span class="p">)</span>
			<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;ssh-add </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">insecure_ssh_private_key</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
	<span class="n">init</span><span class="p">()</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
