<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>announce.py</title>
  <link rel="stylesheet" href="../../../pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>announce.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Send UDP broadcast packets</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">psutil</span><span class="o">,</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">portalocker</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">tinydb</span> <span class="kn">import</span> <span class="n">TinyDB</span><span class="p">,</span> <span class="n">Query</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">util</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">start</span><span class="p">():</span>

	<span class="n">logger</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Starting broadcast service.&#39;</span><span class="p">)</span>
	<span class="n">current_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwdu</span><span class="p">()</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;builder&#39;</span><span class="p">,</span> <span class="s1">&#39;announce&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">current_file_path</span><span class="p">)</span>
	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; OK.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Log status</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Started broadcast service.&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">4445</span><span class="p">,</span> <span class="n">broadcast_address</span><span class="o">=</span><span class="s1">&#39;192.168.1.255&#39;</span><span class="p">,</span> <span class="n">broadcast_timeout</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>

	<span class="n">logger</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

	<span class="n">addresses</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_inet_addresses</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Write pid into pidfile</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
	<span class="n">pidfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pid&#39;</span> <span class="o">%</span> <span class="vm">__name__</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>TODO: get name of file for naming "builder.<filename>.pid"
TODO: tempfile.NamedTemporaryFile(prefix='builder.broadcast.', suffix='.pid').name</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">pidfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pidfile_path</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>portalocker.lock(pidfile, portalocker.LOCK_EX) # lock the pidfile</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">pidfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
	<span class="n">pidfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="n">device_uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>s.bind(('', 0))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
	<span class="n">s</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_BROADCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

	<span class="n">s</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>s.settimeout(2)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>"\f<content_length>\t<content_checksum>\t<content_type>\t<content>"
e.g., "\f52 16561   text    announce device 002fffff-ffff-ffff-4e45-3158200a0015"
data = "\f52\t16561\ttext\tannounce device 002fffff-ffff-ffff-4e45-3158200a0015";
data = "\f52\t33439\ttext\tannounce device f1aceb8b-e8e9-4cda-b29c-de7bc7cc390f"</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">builder_config</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">load_builderfile</span><span class="p">()</span>
	<span class="n">broadcast_message</span> <span class="o">=</span> <span class="s1">&#39;announce</span><span class="se">\n\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">builder_config</span><span class="p">)</span>
	<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">broadcast_message</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>broadcast_message = "announce device %s" % device_uuid</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

		<span class="n">current_time</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">response_start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>

		<span class="k">while</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">response_start_time</span> <span class="o">&lt;</span> <span class="n">broadcast_timeout</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Receive UDP message</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">message</span><span class="p">,</span> <span class="n">fromaddr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

				<span class="k">if</span> <span class="ow">not</span> <span class="n">fromaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">addresses</span><span class="p">:</span> <span class="c1"># Prevents reading packets from the host machine (i.e., broadcasts don&#39;t loop back)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>TODO: abstract this out based on 'requests' library abstraction level, then put it up on github and pip!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>					<span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;announce&quot;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Log status</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Response from </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fromaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fromaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">message</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>HACK
TODO: rename 'device' to something better...
TODO: don't populate this data here... create the structure on the sender's side</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;announce&#39;</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
						<span class="n">device</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
						<span class="n">device</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
						<span class="n">device</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">][</span><span class="s1">&#39;ip4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fromaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
						<span class="n">device</span><span class="p">[</span><span class="s1">&#39;time_created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
						<span class="n">device</span><span class="p">[</span><span class="s1">&#39;time_updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Save device status in registry (in SQLite database)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="n">builder_db_path</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_database_path</span><span class="p">()</span>
						<span class="n">db</span> <span class="o">=</span> <span class="n">TinyDB</span><span class="p">(</span><span class="n">builder_db_path</span><span class="p">,</span> <span class="n">default_table</span><span class="o">=</span><span class="s1">&#39;builder&#39;</span><span class="p">)</span>
						<span class="n">device_table</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">)</span>

						<span class="n">Device</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span>
						<span class="n">device_element</span> <span class="o">=</span> <span class="n">device_table</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">device</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
						<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">device_element</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
							<span class="n">device_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">device</span><span class="p">[</span><span class="s1">&#39;time_created&#39;</span><span class="p">]</span>
							<span class="n">device_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">Device</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">device</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Create device folder if doesn't already exist</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="n">builder_root</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_builder_root</span><span class="p">()</span>

						<span class="n">builder_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">builder_root</span><span class="p">,</span> <span class="s1">&#39;.builder&#39;</span><span class="p">)</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">builder_folder</span><span class="p">):</span>
							<span class="k">print</span> <span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">builder_folder</span>
							<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">builder_folder</span><span class="p">)</span>

						<span class="n">device_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">builder_root</span><span class="p">,</span> <span class="s1">&#39;.builder&#39;</span><span class="p">,</span> <span class="s1">&#39;devices&#39;</span><span class="p">)</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">device_folder</span><span class="p">):</span>
							<span class="k">print</span> <span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">device_folder</span> 
							<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">device_folder</span><span class="p">)</span>

						<span class="n">machine_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">builder_root</span><span class="p">,</span> <span class="s1">&#39;.builder&#39;</span><span class="p">,</span> <span class="s1">&#39;devices&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">machine_folder</span><span class="p">):</span>
							<span class="k">print</span> <span class="s1">&#39;mkdir </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">machine_folder</span>
							<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">machine_folder</span><span class="p">)</span>

					<span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">):</span>
						<span class="n">response_message</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> <span class="c1"># remove &quot;echo &quot; from start of string</span>
						<span class="n">serverSocket</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">response_message</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Undefined message</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="bp">None</span>

			<span class="k">except</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Timeout
TODO: Log exception!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="bp">None</span>

			<span class="n">current_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Send periodic broadcast</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">broadcast_message</span><span class="p">,</span> <span class="p">(</span><span class="n">broadcast_address</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span> <span class="c1"># Works</span>

	<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">stop</span><span class="p">():</span>

	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Stopping broadcast service.&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Log status</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">logger</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
	<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stopped broadcast service.&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Locate pidfile (if it exists)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
	<span class="n">pidfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pid&#39;</span> <span class="o">%</span> <span class="vm">__name__</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Read pid from pidfile</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">pidfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pidfile_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
	<span class="n">content</span> <span class="o">=</span> <span class="n">pidfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
	<span class="n">pidfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="p">]</span> <span class="c1"># remove whitespace characters like `\n` at the end of each line</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>print content</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Kill process</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">util</span><span class="o">.</span><span class="n">kill_proc_tree</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>Delete pidfile</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pidfile_path</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Status</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; OK.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
	<span class="n">run</span><span class="p">()</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
